import{proxy,subscribe,snapshot}from"valtio";import*as React from"react";import{createVerify,createHmac,createSign}from"crypto";var __assign=function(){return(__assign=Object.assign||function(e){for(var t,n=1,r=arguments.length;n<r;n++)for(var a in t=arguments[n])Object.prototype.hasOwnProperty.call(t,a)&&(e[a]=t[a]);return e}).apply(this,arguments)};function __rest(e,t){var n={};for(a in e)Object.prototype.hasOwnProperty.call(e,a)&&t.indexOf(a)<0&&(n[a]=e[a]);if(null!=e&&"function"==typeof Object.getOwnPropertySymbols)for(var r=0,a=Object.getOwnPropertySymbols(e);r<a.length;r++)t.indexOf(a[r])<0&&Object.prototype.propertyIsEnumerable.call(e,a[r])&&(n[a[r]]=e[a[r]]);return n}function __awaiter(e,o,s,c){return new(s=s||Promise)(function(n,t){function r(e){try{i(c.next(e))}catch(e){t(e)}}function a(e){try{i(c.throw(e))}catch(e){t(e)}}function i(e){var t;e.done?n(e.value):((t=e.value)instanceof s?t:new s(function(e){e(t)})).then(r,a)}i((c=c.apply(e,o||[])).next())})}function __generator(r,a){var i,o,s,c={label:0,sent:function(){if(1&s[0])throw s[1];return s[1]},trys:[],ops:[]},e={next:t(0),throw:t(1),return:t(2)};return"function"==typeof Symbol&&(e[Symbol.iterator]=function(){return this}),e;function t(n){return function(e){var t=[n,e];if(i)throw new TypeError("Generator is already executing.");for(;c;)try{if(i=1,o&&(s=2&t[0]?o.return:t[0]?o.throw||((s=o.return)&&s.call(o),0):o.next)&&!(s=s.call(o,t[1])).done)return s;switch(o=0,(t=s?[2&t[0],s.value]:t)[0]){case 0:case 1:s=t;break;case 4:return c.label++,{value:t[1],done:!1};case 5:c.label++,o=t[1],t=[0];continue;case 7:t=c.ops.pop(),c.trys.pop();continue;default:if(!(s=0<(s=c.trys).length&&s[s.length-1])&&(6===t[0]||2===t[0])){c=0;continue}if(3===t[0]&&(!s||t[1]>s[0]&&t[1]<s[3])){c.label=t[1];break}if(6===t[0]&&c.label<s[1]){c.label=s[1],s=t;break}if(s&&c.label<s[2]){c.label=s[2],c.ops.push(t);break}s[2]&&c.ops.pop(),c.trys.pop();continue}t=a.call(r,c)}catch(e){t=[6,e],o=0}finally{i=s=0}if(5&t[0])throw t[1];return{value:t[0]?t[1]:void 0,done:!0}}}}var cacheTransport={serialize:function(e,t){void 0!==t&&localStorage.setItem("wen-session",JSON.stringify(t)),localStorage.setItem("wen-wallet",JSON.stringify(e))},deserialize:function(){var e,t,n,r=localStorage.getItem("wen-wallet"),a=localStorage.getItem("wen-session");return r?(e=(r=JSON.parse(r)).address,t=r.balance,n=r.connected,r=r.connector,a=a?JSON.parse(a):{},__assign({address:e,balance:t,connected:n,connector:r},a)):{address:"",balance:0,connected:!1,connector:null}}},ssrTransport={setToken:function(t,n){return __awaiter(void 0,void 0,void 0,function(){return __generator(this,function(e){switch(e.label){case 0:return[4,fetch("/api/wen",{method:"POST",body:JSON.stringify(__assign({wallet:t},void 0!==n&&n))})];case 1:return e.sent(),[2]}})})},removeToken:function(){fetch("/api/wen",{method:"DELETE"})}},injected={name:"injected",requestAccounts:function(){return __awaiter(void 0,void 0,void 0,function(){var t,n;return __generator(this,function(e){switch(e.label){case 0:if(!(t=window.ethereum))return[2,[]];e.label=1;case 1:return e.trys.push([1,3,,4]),[4,t.request({method:"eth_requestAccounts"})];case 2:return(n=e.sent())&&n.length?[2,n]:[2,[]];case 3:return e.sent(),[2,[]];case 4:return[2]}})})},requestBalance:function(r){return __awaiter(void 0,void 0,void 0,function(){var t,n;return __generator(this,function(e){switch(e.label){case 0:if(!(t=window.ethereum))return[2,[]];e.label=1;case 1:return e.trys.push([1,3,,4]),[4,t.request({method:"eth_getBalance",params:[r,"latest"]})];case 2:return(n=e.sent())&&n.length?[2,n]:[2,[]];case 3:return n=e.sent(),console.log(n),[2,[]];case 4:return[2]}})})},requestChainId:function(){return __awaiter(void 0,void 0,void 0,function(){var t,n;return __generator(this,function(e){switch(e.label){case 0:if(!(t=window.ethereum))return[2,[]];e.label=1;case 1:return e.trys.push([1,3,,4]),[4,t.request({method:"eth_chainId"})];case 2:return(n=e.sent())&&n.length?[2,n]:[2,[]];case 3:return n=e.sent(),console.log(n),[2,[]];case 4:return[2]}})})},switchChain:function(r){return __awaiter(void 0,void 0,void 0,function(){var t,n;return __generator(this,function(e){switch(e.label){case 0:if(!(t=window.ethereum))return[2,[]];e.label=1;case 1:return e.trys.push([1,3,,4]),[4,t.request({method:"wallet_switchEthereumChain",params:[{chainId:r}]})];case 2:return(n=e.sent())&&n.length?[2,n]:[2,[]];case 3:return n=e.sent(),console.log(n),[2,[]];case 4:return[2]}})})},listen:function(e,t){var n=window.ethereum;null!=n&&n.on&&(n.on("accountsChanged",e),n.on("chainChanged",t))}},initialWallet={address:"",balance:"",connected:!1,connector:null,chainId:""},InitialSession={wallet:initialWallet},InitialDesiredState={method:"injected"},Wen=function(){function e(e){var t,n,r,a,i,e=e.ssr,e=void 0!==e&&e,o=this;this.isClient="undefined"!=typeof window,this._session=proxy({}),this.wallet=proxy(initialWallet),this._onAccountChange=function(r){return __awaiter(o,void 0,void 0,function(){var t,n;return __generator(this,function(e){switch(e.label){case 0:return r.length?[4,injected.requestBalance(r[0])]:(this.disconnect(),[2]);case 1:return t=e.sent(),[4,injected.requestChainId()];case 2:return n=e.sent(),this.wallet.address=r[0],this.wallet.balance=t,this.wallet.connected=!0,this.wallet.chainId=n,this._serialize(),[2]}})})},this._onNetworkChange=function(e){console.log(o.wallet),o.wallet.chainId=e,o._serialize()},this._destroySession=function(){o._session=proxy({}),o._serialize()},this.connect=function(a){return void 0===a&&(a=InitialDesiredState),__awaiter(o,void 0,void 0,function(){var t,n,r;return __generator(this,function(e){switch(e.label){case 0:return[3,1];case 1:return[4,injected.requestAccounts()];case 2:return t=e.sent(),[4,injected.requestBalance(t[0])];case 3:return n=e.sent(),[4,injected.requestChainId()];case 4:return r=e.sent(),a.chainId&&a.chainId!==r&&injected.switchChain(a.chainId),t.length?(this.wallet.address=t[0],this.wallet.connected=!0,this.wallet.balance=n,this.wallet.chainId=r,this.wallet.connector="injected",cacheTransport.serialize(this.wallet),this.ssrSession&&ssrTransport.setToken(this.wallet),[2,this.wallet.address]):[2,""]}})})},this.disconnect=function(){o.wallet.address="",o.wallet.balance="",o.wallet.connected=!1,o.wallet.connector=null,o.wallet.chainId="",cacheTransport.serialize(o.wallet,{}),o.ssrSession&&ssrTransport.removeToken(),o._destroySession()},this.saveSession=function(t){return __awaiter(o,void 0,void 0,function(){return __generator(this,function(e){return this._session=proxy(t),cacheTransport.serialize(this.wallet,t),Promise.resolve(),this.ssrSession&&ssrTransport.setToken(this.wallet,t),[2]})})},this.ssrSession=e,this.isClient&&(t=(e=cacheTransport.deserialize()).address,n=e.balance,r=e.connected,a=e.connector,i=e.chainId,e=__rest(e,["address","balance","connected","connector","chainId"]),this.wallet=proxy({address:t,balance:n,connected:r,connector:a,chainId:i}),this._session=proxy(e),this.listen())}return e.prototype.listen=function(){injected.listen(this._onAccountChange,this._onNetworkChange)},e.prototype._serialize=function(){cacheTransport.serialize(this.wallet),this.ssrSession&&ssrTransport.setToken(this.wallet)},Object.defineProperty(e.prototype,"session",{get:function(){return this._session},enumerable:!1,configurable:!0}),e}(),WenContext=React.createContext(void 0),WenProvider=function(e){var t=e.children,e=e.config,e=new Wen(e);return React.createElement(WenContext.Provider,{value:e},t)},useWen=function(e){void 0===e&&(e=InitialSession);var t=React.useContext(WenContext);if(void 0===t)throw new Error("useWen must be used within a WenProvider");var e=React.useState(e.wallet),n=e[0],r=e[1];return subscribe(t.wallet,function(){r(snapshot(t.wallet))}),React.useEffect(function(){r(snapshot(t.wallet))},[]),{connect:t.connect,disconnect:t.disconnect,wallet:n}},algorithmMap={HS256:"sha256",HS384:"sha384",HS512:"sha512",RS256:"RSA-SHA256"},typeMap={HS256:"hmac",HS384:"hmac",HS512:"hmac",RS256:"sign"},decode=function(e,t,n,r){if(!e)throw Error("No token supplied");e=e.split(".");if(3!==e.length)throw Error("Not enough or too many segments");var a=e[0],i=e[1],e=e[2],o=JSON.parse(base64urlDecode(a)),s=JSON.parse(base64urlDecode(i));if(!n){!r&&/BEGIN( RSA)? PUBLIC KEY/.test(t.toString())&&(r="RS256");n=algorithmMap[r||o.alg],r=typeMap[r||o.alg];if(!n||!r)throw Error("Algorithm not supported");if(!verify([a,i].join("."),t,n,r,e))throw Error("Signature verification failed");if(s.nbf&&Date.now()<1e3*s.nbf)throw Error("Token not yet active");if(s.exp&&Date.now()>1e3*s.exp)throw Error("Token expired")}return s},encode=function(e,t,n,r){if(!t)throw Error("Require key");var a=algorithmMap[n=n||"HS256"],i=typeMap[n];if(!a||!i)throw Error("Algorithm not supported");n={typ:"JWT",alg:n},r&&r.header&&assignProperties(n,r.header),r=[];return r.push(base64urlEncode(JSON.stringify(n))),r.push(base64urlEncode(JSON.stringify(e))),r.push(sign(r.join("."),t,a,i)),r.join(".")};function assignProperties(e,t){for(var n in t)t.hasOwnProperty(n)&&(e[n]=t[n])}function verify(e,t,n,r,a){if("hmac"===r)return a===sign(e,t,n,r);if("sign"==r)return createVerify(n).update(e).verify(t,base64urlUnescape(a),"base64");throw Error("Algorithm type not recognized")}function sign(e,t,n,r){var a;if("hmac"===r)a=createHmac(n,t).update(e).digest("base64");else{if("sign"!=r)throw Error("Algorithm type not recognized");a=createSign(n).update(e).sign(t,"base64")}return base64urlEscape(a)}function base64urlDecode(e){return Buffer.from(base64urlUnescape(e),"base64").toString()}function base64urlUnescape(e){return(e+=Array.from({length:5-e.length%4}).join("=")).replace(/\-/g,"+").replace(/_/g,"/")}function base64urlEncode(e){return base64urlEscape(Buffer.from(e).toString("base64"))}function base64urlEscape(e){return e.replace(/\+/g,"-").replace(/\//g,"_").replace(/=/g,"")}var decodeToken=function(e,t){if(0===e.length)return{};try{return decode(e,t)}catch(e){return{}}},WenConnect=function(a,i){return __awaiter(void 0,void 0,void 0,function(){var t,n,r;return __generator(this,function(e){if(!(t=process.env.WEN_SECRET))return[2,i.status(500).json({error:"WEN_SECRET environment variable is not set"})];switch(a.method){case"POST":return(r=JSON.parse(a.body),n=r.wallet,r=__rest(r,["wallet"]),n)?(r=encode(__assign({wallet:n},r),t),i.setHeader("Set-Cookie",["wen-wallet=".concat(r,"; Path=/ ; Secure ; HttpOnly ; SameSite=Strict ; Max-Age=604800 ;")]),[2,i.status(200).json({token:r,wallet:n})]):(i.status(400).json({error:"Missing wallet"}),[2]);case"DELETE":return a.cookies["wen-wallet"]?(i.setHeader("Set-Cookie",["wen-wallet=deleted; Path=/; Secure ; HttpOnly ; SameSite=Strict ; expires=Thu, 01 Jan 1970 00:00:00 GMT"]),[2,i.status(200).json({deleted:!0})]):[2,null];case"GET":return a.cookies["wen-wallet"]?(r=decodeToken(a.cookies["wen-wallet"],process.env.WEN_SECRET),[2,i.status(200).json(r)]):[2,i.status(200).json({})];default:return[2,i.status(405).end("Method ".concat(a.method," Not Allowed"))]}})})},getSession=function(e){e=e.req;if(!e.cookies["wen-wallet"])return{wallet:initialWallet};var t=process.env.WEN_SECRET;if(!t)return{wallet:initialWallet};try{return decodeToken(e.cookies["wen-wallet"],t)}catch(e){return{wallet:initialWallet}}};export{InitialDesiredState,InitialSession,Wen,WenConnect,WenProvider,decode,encode,getSession,initialWallet,useWen};
